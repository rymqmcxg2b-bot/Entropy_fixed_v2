<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AETHEL OS â€” æˆ€äººå­˜æª” / ç†µä¹‹è£‚ç¸«</title>

  <style>
    /* ==========================================
       AETHEL OS â€” UI THEME / TOKENS
       ========================================== */
    :root{
      --neon-blue:#00f2ff;
      --glitch-red:#ff3e3e;
      --terminal-green:#00ff41;
      --bg-blur:rgba(10,10,10,.72);
      --panel:rgba(18,18,20,.62);
      --panel-strong:rgba(18,18,20,.82);
      --line:rgba(255,255,255,.10);
      --text:#e9eef2;
      --muted:rgba(233,238,242,.72);
      --shadow:0 20px 60px rgba(0,0,0,.45);
      --r:18px;
      --mono:"Courier New", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "å¾®è»Ÿæ­£é»‘é«”";
      --ui:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
    }

    /* ==========================================
       GLOBAL / BACKDROP
       ========================================== */
    html, body { height: 100%; }
    body{
      margin:0;
      background:#000;
      color:var(--text);
      overflow:hidden;
      font-family:var(--mono);
      letter-spacing:.2px;
      user-select:none;
    }

    #vfx-canvas{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      z-index:-3;
    }

    /* subtle scanlines */
    .scanlines{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:-2;
      background:repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.02),
        rgba(255,255,255,.02) 1px,
        rgba(0,0,0,0) 3px,
        rgba(0,0,0,0) 6px
      );
      mix-blend-mode:overlay;
      opacity:.55;
      animation: scanShift 8s linear infinite;
    }
    @keyframes scanShift{
      0%{ transform:translateY(0); }
      100%{ transform:translateY(18px); }
    }

    /* occasional glitch overlay */
    .glitch-overlay{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:-1;
      opacity:0;
      background:
        linear-gradient(90deg, rgba(255,62,62,.10), rgba(0,242,255,.10)),
        radial-gradient(circle at 20% 30%, rgba(0,242,255,.10), transparent 40%),
        radial-gradient(circle at 70% 60%, rgba(255,62,62,.10), transparent 45%);
      mix-blend-mode:screen;
      filter:contrast(120%) saturate(110%);
    }
    .glitch-on{ animation: glitchFlash 260ms steps(2,end) 1; }
    @keyframes glitchFlash{
      0%{ opacity:0; transform:translate(0,0); }
      30%{ opacity:.75; transform:translate(2px,-1px); }
      60%{ opacity:.35; transform:translate(-3px,1px); }
      100%{ opacity:0; transform:translate(0,0); }
    }

    /* ==========================================
       LAYOUT â€” 3 COLUMNS: NAV / PHONE / MONITOR
       ========================================== */
    #os-container{
      height:100vh;
      display:grid;
      grid-template-columns: 96px minmax(340px, 1fr) 360px;
      gap:14px;
      padding:14px;
      backdrop-filter: blur(10px);
    }

    /* NAV */
    #nav-sidebar{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(10,10,12,.60), rgba(10,10,12,.35));
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:12px 10px;
      gap:10px;
    }

    .brand{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      background:rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:6px;
    }
    .brand .t1{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }
    .brand .t2{
      font-family:var(--mono);
      font-size:14px;
      color:var(--neon-blue);
      letter-spacing:.8px;
    }

    .app-icon{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      display:grid;
      place-items:center;
      cursor:pointer;
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
      position:relative;
      overflow:hidden;
    }
    .app-icon:hover{
      transform: translateY(-1px);
      border-color: rgba(0,242,255,.40);
      background: rgba(0,242,255,.06);
    }
    .app-icon.active{
      border-color: rgba(0,242,255,.65);
      box-shadow: 0 0 0 1px rgba(0,242,255,.35) inset;
      background: rgba(0,242,255,.10);
    }
    .app-icon .emoji{ font-size:28px; }
    .app-icon .dot{
      position:absolute; right:10px; bottom:10px;
      width:8px; height:8px; border-radius:50%;
      background: rgba(0,255,65,.85);
      box-shadow: 0 0 12px rgba(0,255,65,.55);
      opacity:0;
    }
    .app-icon.has-new .dot{ opacity:1; }

    /* PHONE */
    #phone-display{
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(18,18,20,.72), rgba(18,18,20,.44));
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      position:relative;
    }

    #status-bar{
      height:44px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.20);
    }
    #status-bar .left{
      display:flex; gap:10px; align-items:center;
    }
    #status-bar .pill{
      border:1px solid var(--line);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    #battery{
      color: var(--glitch-red);
    }

    #content-body{
      flex:1;
      overflow:auto;
      padding:14px 14px 10px;
      scroll-behavior:smooth;
    }
    #content-body::-webkit-scrollbar{ width: 10px; }
    #content-body::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.25);
    }

    #input-dock{
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.18);
      padding:10px 12px 12px;
    }
    #reply-options{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }

    .btn{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      max-width: 100%;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(0,242,255,.40);
      background: rgba(0,242,255,.10);
    }
    .btn:active{
      transform: translateY(0);
    }
    .btn.disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    /* CHAT UI */
    .chat-thread{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .msg{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      max-width: 86%;
      position:relative;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .msg .meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:11px;
      color: var(--muted);
      margin-bottom:6px;
    }
    .msg .sender{
      color: var(--neon-blue);
      letter-spacing:.6px;
    }
    .msg .time{
      opacity:.8;
    }
    .msg .text{
      font-size:13px;
      line-height:1.55;
      white-space:pre-wrap;
    }
    .msg.mine{
      align-self:flex-end;
      border-color: rgba(0,242,255,.18);
      background: rgba(0,242,255,.06);
    }
    .msg.mine .sender{
      color: rgba(233,238,242,.90);
    }

    .inline-img{
      margin-top:8px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    .inline-img img{ display:block; width:100%; height:auto; opacity:.92; }

    .typewriter-caret{
      display:inline-block;
      width:10px;
      margin-left:2px;
      color: var(--terminal-green);
      animation: caretBlink 850ms steps(2,end) infinite;
    }
    @keyframes caretBlink{
      0%, 50%{ opacity:1; }
      51%, 100%{ opacity:0; }
    }

    /* NOTES */
    .notes-wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .note-card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .note-card h4{
      margin:0 0 8px;
      font-size:13px;
      color: var(--neon-blue);
    }
    .note-card p{
      margin:0;
      font-size:13px;
      line-height:1.6;
      color: rgba(233,238,242,.90);
      white-space:pre-wrap;
    }

    /* GALLERY */
    .gallery-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
    }
    .photo{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
      background: rgba(0,0,0,.18);
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease;
    }
    .photo:hover{
      transform: translateY(-1px);
      border-color: rgba(0,242,255,.35);
    }
    .photo img{ display:block; width:100%; height:140px; object-fit:cover; opacity:.90; }
    .photo .cap{
      padding:10px 10px 12px;
      font-size:12px;
      color: rgba(233,238,242,.82);
    }

    /* SYSTEM */
    .sys-wrap{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .sys-card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .sys-card .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color: rgba(233,238,242,.86);
      padding:6px 0;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .sys-card .row:last-child{ border-bottom:none; }
    .tag{
      border:1px solid rgba(255,255,255,.12);
      padding:3px 8px;
      border-radius:999px;
      color: rgba(233,238,242,.85);
      background: rgba(255,255,255,.05);
      font-size:11px;
      white-space:nowrap;
    }
    .tag.blue{ border-color: rgba(0,242,255,.25); background: rgba(0,242,255,.08); }
    .tag.green{ border-color: rgba(0,255,65,.22); background: rgba(0,255,65,.08); }

    /* MONITOR */
    #monitor{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(10,10,12,.70), rgba(10,10,12,.42));
      box-shadow:var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    #monitor header{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    #monitor header h3{
      margin:0;
      font-size:13px;
      letter-spacing:.8px;
      color: rgba(233,238,242,.92);
    }
    #monitor header .mini{
      display:flex; gap:8px; align-items:center;
      color: var(--muted);
      font-size:11px;
    }

    #chart{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    #chart-canvas{
      width:100%;
      height:260px;
      display:block;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background: rgba(0,0,0,.22);
    }

    #log-console{
      flex:1;
      padding:12px;
      overflow:auto;
      font-size:11px;
      color: rgba(233,238,242,.84);
      line-height:1.45;
      white-space:pre-wrap;
    }
    #log-console::-webkit-scrollbar{ width: 10px; }
    #log-console::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.10);
      border-radius: 999px;
      border: 2px solid rgba(0,0,0,.25);
    }

    /* Small "shake" effect (simulated vibration) */
    .shake{
      animation: shake 220ms ease-in-out 1;
    }
    @keyframes shake{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(2px,-1px); }
      50%{ transform: translate(-3px,1px); }
      75%{ transform: translate(2px,1px); }
      100%{ transform: translate(0,0); }
    }

    /* responsive fallback */
    @media (max-width: 1080px){
      #os-container{
        grid-template-columns: 86px 1fr;
      }
      #monitor{ display:none; }
    }
  </style>
</head>

<body>
  <canvas id="vfx-canvas"></canvas>
  <div class="scanlines"></div>
  <div id="glitch" class="glitch-overlay"></div>

  <div id="os-container">
    <nav id="nav-sidebar">
      <div class="brand">
        <div class="t1">AETHEL OS</div>
        <div class="t2">ENTROPY / FULL</div>
      </div>

      <div class="app-icon active" data-app="chat" title="Chat">
        <span class="emoji">ğŸ’¬</span>
        <span class="dot"></span>
      </div>
      <div class="app-icon" data-app="notes" title="Notes">
        <span class="emoji">ğŸ“</span>
        <span class="dot"></span>
      </div>
      <div class="app-icon" data-app="gallery" title="Gallery">
        <span class="emoji">ğŸ–¼ï¸</span>
        <span class="dot"></span>
      </div>
      <div class="app-icon" data-app="system" title="System">
        <span class="emoji">âš™ï¸</span>
        <span class="dot"></span>
      </div>
    </nav>

    <main id="phone-display">
      <div id="status-bar">
        <div class="left">
          <span id="clock" class="pill">--:--</span>
          <span class="pill">5G</span>
          <span class="pill" id="signal">[|||| ]</span>
        </div>
        <div class="right">
          <span class="pill" id="battery">1%</span>
        </div>
      </div>

      <div id="content-body"></div>

      <div id="input-dock">
        <div id="reply-options"></div>
      </div>
    </main>

    <aside id="monitor">
      <header>
        <h3>æ„è­˜ä¸€è‡´æ€§åˆ†æ</h3>
        <div class="mini">
          <span class="tag blue" id="tag-app">APP: chat</span>
          <span class="tag green" id="tag-state">STATE: ACTIVE</span>
        </div>
      </header>

      <div id="chart">
        <canvas id="chart-canvas" width="320" height="260"></canvas>
      </div>

      <div id="log-console"></div>
    </aside>
  </div>

<script>
/* =========================================================
   AETHEL OS â€” FULL EDITION
   Architecture:
   - VFXEngine: canvas noise + matrix rain + glitch cues
   - ScriptDB: data model for chat / notes / gallery / system
   - DialogEngine: typewriter + branching replies + unlock
   - StateMachine: app routing + progress gating + scoring
   - ConsciousnessAudit: micro-actions -> report + chart
   ========================================================= */

/* =========================================================
   Utility
   ========================================================= */
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));

function nowHHMM(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function softLog(lines){
  const el = $("#log-console");
  const s = Array.isArray(lines) ? lines.join("\n") : String(lines);
  el.textContent += (el.textContent ? "\n" : "") + s;
  el.scrollTop = el.scrollHeight;
}

/* =========================================================
   PART 1 â€” VFX Engine
   ========================================================= */
class VFXEngine{
  constructor(canvas, glitchEl){
    this.canvas = canvas;
    this.ctx = canvas.getContext("2d", { alpha: true });
    this.glitchEl = glitchEl;

    this.w = 0;
    this.h = 0;

    // matrix rain
    this.cols = 0;
    this.colW = 14;
    this.drops = [];

    // noise
    this.noiseSeed = Math.random()*9999;

    // glitch scheduling
    this.nextGlitchAt = performance.now() + 1800 + Math.random()*2200;
    this.enabled = true;

    this.resize();
    window.addEventListener("resize", ()=>this.resize());
  }

  resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    this.w = Math.floor(window.innerWidth * dpr);
    this.h = Math.floor(window.innerHeight * dpr);
    this.canvas.width = this.w;
    this.canvas.height = this.h;
    this.canvas.style.width = window.innerWidth + "px";
    this.canvas.style.height = window.innerHeight + "px";

    this.cols = Math.ceil(this.w / (this.colW*dpr));
    this.drops = new Array(this.cols).fill(0).map(()=>Math.random()*this.h);
    this.ctx.setTransform(1,0,0,1,0,0);
  }

  triggerGlitch(){
    if(!this.enabled) return;
    this.glitchEl.classList.remove("glitch-on");
    void this.glitchEl.offsetWidth; // reflow
    this.glitchEl.classList.add("glitch-on");
  }

  drawNoise(t){
    // cheap animated grain
    const ctx = this.ctx;
    const step = 3; // larger => faster, less detailed
    const alpha = 0.06;
    ctx.save();
    ctx.globalAlpha = alpha;

    for(let y=0; y<this.h; y+=step*6){
      for(let x=0; x<this.w; x+=step*6){
        const n = (Math.sin((x*0.02) + (y*0.03) + (t*0.001) + this.noiseSeed) + 1) * 0.5;
        const g = Math.floor(20 + n*60);
        ctx.fillStyle = `rgb(${g},${g},${g})`;
        ctx.fillRect(x, y, step*2, step*2);
      }
    }
    ctx.restore();
  }

  drawMatrix(t){
    const ctx = this.ctx;
    ctx.save();
    ctx.font = `${12 * (this.w / window.innerWidth)}px Courier New`;
    ctx.textBaseline = "top";

    const chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ#$%&*+=-";
    for(let i=0; i<this.cols; i++){
      const x = i * (this.colW * (this.w / window.innerWidth));
      const y = this.drops[i];

      const c = chars[Math.floor(Math.random() * chars.length)];
      ctx.fillStyle = "rgba(0,255,65,0.14)";
      ctx.fillText(c, x, y);

      // occasional brighter head
      if(Math.random()<0.025){
        ctx.fillStyle = "rgba(0,255,65,0.38)";
        ctx.fillText(chars[Math.floor(Math.random() * chars.length)], x, y-14);
      }

      const speed = 16 + (i%7)*2;
      this.drops[i] += speed;

      if(this.drops[i] > this.h + 40){
        this.drops[i] = -Math.random()*120;
      }
    }

    ctx.restore();
  }

  tick(t){
    if(!this.enabled) return;

    const ctx = this.ctx;
    // clear with translucency for trails
    ctx.fillStyle = "rgba(0,0,0,0.22)";
    ctx.fillRect(0, 0, this.w, this.h);

    this.drawNoise(t);
    this.drawMatrix(t);

    if(t >= this.nextGlitchAt){
      this.triggerGlitch();
      this.nextGlitchAt = t + 1800 + Math.random()*2200;
    }
    requestAnimationFrame((tt)=>this.tick(tt));
  }
}

/* =========================================================
   PART 2 â€” ScriptDB (Deep Text Database)
   - We keep the structure realistic, and also provide
     a generator to scale the amount of content.
   ========================================================= */

function makeInlineSVGDataURI(label){
  // lightweight pseudo-image; no external assets
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="720" height="420">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#00f2ff" stop-opacity="0.18"/>
        <stop offset="1" stop-color="#ff3e3e" stop-opacity="0.12"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="#0b0b0d"/>
    <rect x="18" y="18" width="684" height="384" rx="20" fill="url(#g)" stroke="rgba(255,255,255,0.12)"/>
    <text x="44" y="86" fill="rgba(233,238,242,0.92)" font-family="Courier New" font-size="28">AETHEL OS / ARCHIVE</text>
    <text x="44" y="132" fill="rgba(0,255,65,0.78)" font-family="Courier New" font-size="18">FILE: ${label}</text>
    <text x="44" y="180" fill="rgba(233,238,242,0.78)" font-family="Courier New" font-size="16">ã€Œåƒæ˜¯æœ‰äººç”¨å¾ˆæ…¢çš„é€Ÿåº¦ï¼ŒæŠŠä¸–ç•Œæ“¦ä¹¾æ·¨ã€‚ã€</text>
    <text x="44" y="210" fill="rgba(233,238,242,0.62)" font-family="Courier New" font-size="14">â€” fragments / entropy crack</text>
  </svg>`;
  const encoded = encodeURIComponent(svg).replace(/'/g,"%27").replace(/"/g,"%22");
  return `data:image/svg+xml;charset=utf-8,${encoded}`;
}

/**
 * Message schema (explicit symbols to avoid ambiguity):
 * - id: string, unique message id
 * - sender: string, display name
 * - text: string, main text (everyday)
 * - thriller: string, optional unsettling subtext
 * - style: string, style tag (e.g. "yoshimoto", "minato")
 * - img: {src, caption} optional inline image
 * - replies: Array<{ text: string, val: { material: number, mind: number }, unlock?: string[] }>
 */

/**
 * Chapter 1 â€” Inbox (hand-written, richer tone)
 * Notes:
 * - The "hollow" feeling often comes from lack of recurring motifs + concrete anchors.
 * - This chapter adds: (a) the fixed timestamp 14:20, (b) count mismatch (2 vs 3 cups),
 *   (c) handwriting imitation, (d) doorplate drift.
 */
const inboxChapter1 = [
  {
    id:"msg_001",
    sender:"Lover",
    text:"å˜¿ï¼Œä½ é‚„è¨˜å¾—æˆ‘å€‘ä¸€èµ·ç¨®çš„é‚£æ ªè–„è·å—ï¼Ÿæˆ‘å‰›æ‰æ¾†æ°´æ™‚ï¼Œç™¼ç¾å®ƒçš„è‘‰å­ç¶ å¾—æœ‰äº›ä¸è‡ªç„¶ã€‚\næˆ‘æŠŠå®ƒç§»åˆ°çª—é‚Šï¼Œå…‰åƒä¸€å±¤è–„è–„çš„ç³–è¡£ï¼Œè¦†åœ¨è‘‰è„ˆä¸Šã€‚",
    thriller:"ä½†å‘³é“ä¸å°ã€‚\nè–„è·çš„æ¸…æ¶¼è£¡æ··è‘—æ²¹æ¼†å‘³ï¼Œåƒå‰›ç²‰åˆ·å®Œçš„ç‰†ã€‚\næˆ‘æ˜æ˜æ²’ç²‰åˆ·ã€‚",
    style:"yoshimoto",
    img:{ src: makeInlineSVGDataURI("mint_plant_001"), caption:"è–„è·ç›†æ ½ / 14:20 / å…‰æºä¸æ˜" },
    replies:[
      { text:"ã€Œå¯èƒ½æ˜¯æœ€è¿‘å¤ªä¹¾ï¼ŒåœŸå‘³è®Šé‡äº†ã€‚ã€", val:{ material: 5, mind: 1 }, unlock:["note_001"] },
      { text:"ã€Œä½ å…ˆåˆ¥é å¤ªè¿‘ï¼Œæè¿°ä¸€ä¸‹æ²¹æ¼†å‘³åƒå“ªä¸€ç¨®ã€‚ã€", val:{ material: 0, mind: 8 }, unlock:["sys_flag_lowpower"] }
    ]
  },

  {
    id:"msg_002",
    sender:"Lover",
    text:"æˆ‘æŠŠçª—ç°¾æ‹‰åˆ°åªå‰©ä¸€æ¢ç¸«ã€‚å®¢å»³å°±åƒç¸®å°æˆç›’å­ã€‚\nç›’å­è£¡æœ‰ä½ ä¸Šæ¬¡ç•™ä¸‹çš„æ¯å­ï¼Œé‚„æœ‰é‚£å€‹æˆ‘å€‘ä¸€ç›´æ‡¶å¾—ä¸Ÿçš„å¸ç®¡ã€‚",
    thriller:"å¯æ˜¯æˆ‘åœ¨æ°´æ§½è£¡åˆçœ‹åˆ°ä¸€å€‹æ¯å­ã€‚\nç¬¬ä¸‰å€‹ã€‚\næˆ‘å€‘å®¶ä¸€ç›´åªæœ‰å…©å€‹æ¯å­ã€‚",
    style:"yoshimoto",
    replies:[
      { text:"ã€Œæ˜¯ä¸æ˜¯ä½ ä¹‹å‰è²·é£²æ–™å¿˜äº†ï¼Ÿã€", val:{ material: 6, mind: 0 }, unlock:["gallery_001"] },
      { text:"ã€Œç¬¬ä¸‰å€‹æ¯å­é•·ä»€éº¼æ¨£ï¼Ÿæœ‰åœ–å—ï¼Ÿã€", val:{ material: 1, mind: 7 }, unlock:["gallery_002"] }
    ]
  },

  {
    id:"msg_003",
    sender:"Lover",
    text:"æˆ‘æ‹äº†ç…§ã€‚\nä½ ä¸è¦ç¬‘æˆ‘ï¼Œæˆ‘æ‹ç…§çš„æ™‚å€™æ‰‹ä¸€ç›´æŠ–ã€‚\næ¯å­å¾ˆæ™®é€šï¼Œæ˜¯é€æ˜çš„ï¼Œåƒä¾¿åˆ©å•†åº—é‚£ç¨®ã€‚\nä½†æ¯å£æœ‰ä¸€åœˆå”‡å°ã€‚",
    thriller:"å”‡å°å¾ˆæ–°ã€‚\næˆ‘ä»Šå¤©æ²’å–ã€‚\nè€Œä¸”é‚£å”‡å°çš„ä½ç½®å¤ªé«˜äº†ï¼Œåƒæ˜¯â€¦ä¸æ˜¯æˆ‘ã€‚",
    style:"minato",
    img:{ src: makeInlineSVGDataURI("cup_003"), caption:"æ°´æ§½ / ç¬¬ä¸‰å€‹æ¯å­ / å”‡å°ä½ç½®ä¸åˆç†" },
    replies:[
      { text:"ã€Œä¹Ÿè¨±æ˜¯ä½ å‰›å‰›æ¼±å£ã€‚ã€", val:{ material: 6, mind: 0 } },
      { text:"ã€ŒæŠŠæ¯å­å…ˆç•™è‘—ï¼Œä¸è¦æ´—ã€‚çœ‹çœ‹æœ‰æ²’æœ‰ä»»ä½•æ¨™ç±¤æˆ–å­—ã€‚ã€", val:{ material: 0, mind: 8 }, unlock:["note_002"] }
    ]
  },

  {
    id:"msg_004",
    sender:"Lover",
    text:"æ¯åº•æœ‰ä¸€ä¸²æ•¸å­—ã€‚\næˆ‘ä»¥ç‚ºæ˜¯å›æ”¶æ¨™èªŒã€‚\nçµæœä¸æ˜¯ï¼Œå®ƒåƒæŸç¨®â€¦ç·¨è™Ÿã€‚\næˆ‘ç”¨æŒ‡ç”²å»åˆ®ï¼Œåˆ®åˆ°æŒ‡å°–ç™¼ç†±ã€‚",
    thriller:"åˆ®æ‰å…©ä½å¾Œï¼Œå‰©ä¸‹çš„éƒ¨åˆ†çœ‹èµ·ä¾†åƒæˆ‘å€‘å®¶çš„é–€ç‰Œã€‚\nä½†å°‘äº†ä¸€å€‹æ•¸å­—ã€‚\nä½ çŸ¥é“å—ï¼Ÿé‚£ç¨®å°‘æ‰çš„æ„Ÿè¦ºå¾ˆåƒå¤±æ†¶ã€‚",
    style:"yoshimoto",
    replies:[
      { text:"ã€Œå…ˆåœä¸‹ï¼Œä¸è¦å†åˆ®äº†ã€‚ä½ èªªé‚£ä¸²æ•¸å­—æ‹çµ¦æˆ‘çœ‹ã€‚ã€", val:{ material: 3, mind: 6 }, unlock:["gallery_003"] },
      { text:"ã€Œå¦‚æœåƒé–€ç‰Œï¼Œé‚£å°±å»é–€å£ç¢ºèªä¸€æ¬¡ã€‚ã€", val:{ material: 2, mind: 7 }, unlock:["note_003"] }
    ]
  },

  {
    id:"msg_005",
    sender:"Lover",
    text:"æˆ‘å»é–€å£äº†ã€‚\nèµ°å»Šå¾ˆå†·ï¼Œåƒæœ‰äººæŠŠå†·æ°£é–‹åœ¨å¤©èŠ±æ¿è£¡ã€‚\né–€ç‰Œé‚„åœ¨ï¼Œä½†æˆ‘ç›¯è‘—çœ‹ï¼Œçœ¼ç›é–‹å§‹é…¸ã€‚",
    thriller:"å› ç‚ºå®ƒä¸€ç¬é–“è®Šæˆå¦ä¸€å€‹æ•¸å­—ã€‚\nä¸æ˜¯éŒ¯ä¸€ä½ï¼Œæ˜¯æ•´å€‹æ ¼å¼éƒ½ä¸ä¸€æ¨£ã€‚\nåƒæ˜¯æˆ‘èµ°éŒ¯æ¨“å±¤ï¼Œä½†æˆ‘æ˜æ˜æ²’å‹•ã€‚",
    style:"minato",
    replies:[
      { text:"ã€Œä½ å¯èƒ½å¤ªç´¯äº†ã€‚å›å®¶ï¼Œå–æ°´ï¼Œåä¸‹ã€‚ã€", val:{ material: 7, mind: 0 } },
      { text:"ã€Œä½ å†çœ‹ä¸€æ¬¡ï¼šä½ ç¾åœ¨çœ‹åˆ°çš„é–€ç‰Œæ˜¯ä»€éº¼ï¼Ÿé€å­—è¬›ã€‚ã€", val:{ material: 0, mind: 9 }, unlock:["sys_flag_lowpower"] }
    ]
  },

  {
    id:"msg_006",
    sender:"Lover",
    text:"æˆ‘åå›æ²™ç™¼äº†ã€‚\nè–„è·åœ¨çª—é‚Šï¼Œçœ‹èµ·ä¾†å¾ˆä¹–ã€‚\nç¬¬ä¸‰å€‹æ¯å­åœ¨æ°´æ§½è£¡ï¼Œçœ‹èµ·ä¾†ä¹Ÿå¾ˆä¹–ã€‚\nå¯æ˜¯é€™ç¨®ã€ä¹–ã€è®“æˆ‘æ›´æ€•ã€‚",
    thriller:"å› ç‚ºå¥½åƒæœ‰äººæ›¿æˆ‘æŠŠä¸€åˆ‡éƒ½æ•´ç†å¥½äº†ã€‚\næ•´ç†åˆ°å‰›å‰›å¥½ï¼Œè®“æˆ‘ä¸æœƒæ±‚æ•‘ã€‚",
    style:"yoshimoto",
    replies:[
      { text:"ã€Œæˆ‘åœ¨ã€‚ä½ å…ˆæŠŠå®¶è£¡ç‡ˆå…¨é–‹ã€‚ã€", val:{ material: 5, mind: 3 } },
      { text:"ã€Œä½ ç¾åœ¨æœ€æ€•çš„æ˜¯ä»€éº¼ï¼Ÿä¸æ˜¯äº‹ä»¶ï¼Œæ˜¯æ„Ÿè¦ºã€‚ã€", val:{ material: 0, mind: 8 } }
    ]
  },

  {
    id:"msg_007",
    sender:"Lover",
    text:"æˆ‘æ‰“é–‹ç‡ˆã€‚\nç‡ˆæ²’æœ‰å£ã€‚\nå£çš„æ˜¯æˆ‘å°å…‰çš„ä¿¡ä»»ã€‚\nå…‰ç…§åˆ°æ¡Œé¢æ™‚ï¼Œæ¡Œä¸Šå¤šäº†ä¸€å¼µä¾¿æ¢ç´™ã€‚",
    thriller:"ä¾¿æ¢ç´™ä¸Šæ˜¯ä½ çš„ç­†è·¡ã€‚\nä½†ä½ æ²’æœ‰ä¾†ã€‚\nä¾¿æ¢ç´™å¯«ï¼šã€ä¸è¦å†å›é ­çœ‹é–€ç‰Œã€‚ã€",
    style:"minato",
    img:{ src: makeInlineSVGDataURI("note_paper_001"), caption:"æ¡Œé¢ä¾¿æ¢ / ç­†è·¡åƒä½  / ä½†æ™‚é–“æˆ³æ˜¯ 14:20" },
    replies:[
      { text:"ã€Œå¯èƒ½æ˜¯ä½ ä»¥å‰å¯«çš„ï¼Œå¿˜äº†ã€‚ã€", val:{ material: 7, mind: 0 } },
      { text:"ã€Œä½ æŠŠå­—é€å­—å¿µçµ¦æˆ‘è½ï¼Œä¸è¦çœç•¥æ¨™é»ã€‚ã€", val:{ material: 0, mind: 9 }, unlock:["note_004"] }
    ]
  },

  {
    id:"msg_008",
    sender:"Lover",
    text:"æˆ‘å¿µå®Œäº†ã€‚\nå¿µå®Œçš„ä¸€ç¬é–“ï¼Œæ‰‹æ©Ÿè‡ªå·±éœ‡äº†ä¸€ä¸‹ã€‚\nå°±åƒå®ƒåœ¨æé†’æˆ‘ï¼šæˆ‘åšå°äº†æŸä»¶äº‹ã€‚",
    thriller:"å¯æ˜¯æˆ‘ä¸æƒ³è¢«çå‹µã€‚\næˆ‘åªæƒ³çŸ¥é“ï¼šèª°åœ¨è¨­è¨ˆé€™äº›çå‹µã€‚",
    style:"yoshimoto",
    replies:[
      { text:"ã€Œå…ˆæŠŠä¾¿æ¢ç´™æ”¶èµ·ä¾†ï¼Œæ”¾é€²æŠ½å±œã€‚ã€", val:{ material: 6, mind: 1 } },
      { text:"ã€Œæ‹ç…§ã€‚ç•™è­‰æ“šã€‚ä¸è¦ç›¸ä¿¡è¨˜æ†¶ã€‚ã€", val:{ material: 2, mind: 7 }, unlock:["gallery_004"] }
    ]
  },

  {
    id:"msg_009",
    sender:"Lover",
    text:"æˆ‘æ‰“é–‹ç›¸ç°¿æƒ³æ‰¾å‰›å‰›çš„ç…§ç‰‡ã€‚\nçµæœç›¸ç°¿è‡ªå·±è·³åˆ°ä¸€å¼µæˆ‘æ²’æ‹éçš„åœ–ã€‚\næ˜¯æˆ‘å€‘å®¶çš„é–€å£ã€‚\nè§’åº¦å¾ˆä½ï¼Œåƒæœ‰äººè¹²è‘—ã€‚",
    thriller:"é–€ç‰Œè™Ÿç¢¼éŒ¯ä¸€ä½ã€‚\néŒ¯å¾—å¾ˆæ•´é½Šã€‚\nåƒä¸€å€‹è¢«èªçœŸç¶­è­·çš„éŒ¯ã€‚",
    style:"minato",
    img:{ src: makeInlineSVGDataURI("door_002"), caption:"é–€å£ / ä½è§’åº¦ / é–€ç‰ŒéŒ¯ä¸€ä½ï¼ˆå›ºå®šéŒ¯ï¼‰" },
    replies:[
      { text:"ã€ŒæŠŠé‚£å¼µåœ–å…ˆå­˜åˆ°é›²ç«¯æˆ–å‚³æˆ‘ã€‚ã€", val:{ material: 4, mind: 5 } },
      { text:"ã€Œä½ çœ‹åœ–çš„å³ä¸‹è§’ï¼Œæœ‰æ²’æœ‰æ™‚é–“ï¼Ÿã€", val:{ material: 0, mind: 9 }, unlock:["note_005"] }
    ]
  },

  {
    id:"msg_010",
    sender:"Lover",
    text:"å³ä¸‹è§’æœ‰æ™‚é–“ã€‚\n14:20ã€‚\næˆ‘è¦ºå¾—å®ƒåƒä¸€æ ¹åˆºï¼Œåˆºåœ¨æ‰€æœ‰æ±è¥¿ä¸Šã€‚\nè–„è·ç…§ç‰‡æ˜¯ 14:20ï¼Œä¾¿æ¢ç´™æ˜¯ 14:20ï¼Œé–€å£ç…§ç‰‡ä¹Ÿæ˜¯ã€‚",
    thriller:"æˆ‘çªç„¶æƒ³åˆ°ï¼š\nå¦‚æœæœ‰äººæŠŠæ™‚é–“é‡˜ä½ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½æŠŠäººä¹Ÿé‡˜ä½ï¼Ÿ",
    style:"yoshimoto",
    replies:[
      { text:"ã€Œä½ å…ˆåˆ¥å†å¾€ä¸‹æŒ–äº†ï¼Œä»Šå¤©åˆ°é€™è£¡ã€‚ã€", val:{ material: 8, mind: 0 } },
      { text:"ã€Œ14:20 é‚£ä¸€åˆ»ï¼Œä½ åœ¨åšä»€éº¼ï¼Ÿæ…¢æ…¢å›æƒ³ã€‚ã€", val:{ material: 0, mind: 10 }, unlock:["note_006"] }
    ]
  },

  {
    id:"msg_011",
    sender:"Lover",
    text:"æˆ‘æƒ³èµ·ä¾†äº†ã€‚\né‚£å¤©ä½ èªªä½ è¦å»è²·è–„è·ã€‚\nä½ èªªï¼šã€æˆ‘å»ä¸€ä¸‹å°±å›ä¾†ã€‚ã€\næˆ‘åœ¨å»šæˆ¿æ´—æ¯å­ã€‚\næˆ‘æ´—äº†å…©å€‹æ¯å­ã€‚",
    thriller:"ä½†æ°´æ§½è£¡å¾Œä¾†è®Šæˆä¸‰å€‹ã€‚\næˆ‘ä¸€ç›´ä»¥ç‚ºæ˜¯æˆ‘è¨˜éŒ¯ã€‚\nå¯æ˜¯ä»Šå¤©å®ƒåˆå›ä¾†äº†ã€‚\nåƒæ˜¯åœ¨æé†’æˆ‘ï¼šæˆ‘ä¸æ˜¯è¨˜éŒ¯ï¼Œæ˜¯è¢«æ”¹å¯«ã€‚",
    style:"minato",
    replies:[
      { text:"ã€Œä¹Ÿè¨±ç¬¬ä¸‰å€‹æ¯å­æ˜¯é‚£å¤©åº—å®¶é™„çš„ã€‚ã€", val:{ material: 6, mind: 0 } },
      { text:"ã€Œå¦‚æœæ˜¯æ”¹å¯«ï¼Œé‚£æ”¹å¯«æ˜¯ç‚ºäº†è®“ä½ ä¸è¿½ç©¶ä»€éº¼ï¼Ÿã€", val:{ material: 0, mind: 10 }, unlock:["sys_flag_lowpower"] }
    ]
  },

  {
    id:"msg_012",
    sender:"Lover",
    text:"æˆ‘çªç„¶å¾ˆæƒ³å•ä½ ä¸€ä»¶äº‹ã€‚\nä½ å…ˆä¸è¦è¦ºå¾—æˆ‘ç˜‹ã€‚\nå¦‚æœæœ‰å¦ä¸€å€‹ç‰ˆæœ¬çš„ä½ ï¼Œä½åœ¨å¦ä¸€å€‹ç‰ˆæœ¬çš„æˆ‘å€‘å®¶ï¼Œ\né‚£ä½ è¦ºå¾—â€¦ä»–æœƒä¸æœƒä¹Ÿåœ¨å®‰æ…°å¦ä¸€å€‹ç‰ˆæœ¬çš„æˆ‘ï¼Ÿ",
    thriller:"æˆ‘è¦ºå¾—æˆ‘ä¸æ˜¯åœ¨è·Ÿä½ èŠå¤©ã€‚\næˆ‘æ˜¯åœ¨è·Ÿã€å¯ä»¥è¢«ä½ ç†è§£çš„é‚£å€‹ä½ ã€èŠå¤©ã€‚\nå‰©ä¸‹çš„éƒ¨åˆ†ï¼Œè¢«èª°è—èµ·ä¾†äº†ã€‚",
    style:"yoshimoto",
    replies:[
      { text:"ã€Œä½ åªéœ€è¦çŸ¥é“ï¼šæˆ‘åœ¨ã€‚ã€", val:{ material: 7, mind: 2 } },
      { text:"ã€Œæˆ‘å€‘å…ˆå®šç¾©ï¼šä»€éº¼å«åŒä¸€å€‹äººã€‚ã€", val:{ material: 0, mind: 10 }, unlock:["note_007"] }
    ]
  }
];

/**
 * Bulk script generator:
 * You can quickly scale to 50â€“80 stages without hand-writing each one.
 * It generates "everyday memory + unsettling crack" pairs.
 */
function generateChatStages(count=24, startIndex=13){
  const base = [];
  const motifs = [
    {a:"å®¶", b:"é–€å£", c:"é–€ç‰Œ"},
    {a:"æ¯å­", b:"æ°´æ§½", c:"å”‡å°"},
    {a:"è–„è·", b:"é™½å°", c:"æ²¹æ¼†å‘³"},
    {a:"çª—ç°¾", b:"èµ°å»Š", c:"è…³æ­¥è²"},
    {a:"å†°ç®±", b:"ä¾¿æ¢ç´™", c:"å¤šå‡ºçš„ä¸€ç­†"},
    {a:"é›»æ¢¯", b:"é¡å­", c:"æ™šä¸€æ­¥çš„å€’å½±"},
    {a:"é›¨", b:"æ¨“æ¢¯é–“", c:"ä¸å±¬æ–¼ä½ çš„é‹å°"},
    {a:"é¤æ¡Œ", b:"åˆ€å‰", c:"æ•¸é‡æ°¸é å¤šä¸€å‰¯"}
  ];

  for(let i=0;i<count;i++){
    const idx = startIndex + i;
    const m = motifs[i % motifs.length];
    base.push({
      id:`msg_${String(idx).padStart(3,'0')}`,
      sender:"Lover",
      text:`æˆ‘ä»Šå¤©æƒ³åˆ°ã€Œ${m.a}ã€é€™å€‹å­—ã€‚å®ƒå¾ˆæ™®é€šï¼Œæ™®é€šåˆ°ä½ ä»¥ç‚ºå®ƒä¸æœƒèƒŒå›ä½ ã€‚\nä½†æˆ‘åœ¨${m.b}çœ‹åˆ°äº†ä¸€å€‹ç´°ç¯€ï¼Œåƒæ˜¯æœ‰äººæŠŠå®ƒæ”¹å¯«æˆåˆ¥äººçš„ç‰ˆæœ¬ã€‚`,
      thriller:`é‚£å€‹ç´°ç¯€æ˜¯ï¼š${m.c}ã€‚\nå®ƒä¸æ˜¯ææ€–ï¼Œå®ƒæ›´åƒæ˜¯ä¸€ç¨®ã€æ­£åœ¨è¢«å–ä»£ã€çš„è­‰æ“šã€‚`,
      style: (i%2===0) ? "yoshimoto" : "minato",
      replies:[
        { text:"ã€Œä¹Ÿè¨±åªæ˜¯å·§åˆã€‚ã€", val:{ material: 5, mind: 1 }, unlock: (i%3===0)?["note_003"]:[] },
        { text:"ã€Œä½ è¦ºå¾—å®ƒåœ¨æé†’ä»€éº¼ï¼Ÿã€", val:{ material: 0, mind: 8 }, unlock: (i%4===0)?["sys_flag_lowpower"]:[] }
      ]
    });
  }
  return base;
}

const ScriptDB = {
  chat: {
    inbox: [...inboxChapter1, ...generateChatStages(24, 13)],
    history: []
  },

  notes: [
    { id:"note_001", title:"é—œæ–¼æ¶ˆå¤±çš„æ—¥è¨˜", content:"ä»Šå¤©æ˜¯ä»–å¤±è¹¤çš„ç¬¬ 89 å¤©ã€‚\næˆ‘åœ¨å»šæˆ¿ç™¼ç¾äº†ç¬¬ä¸‰éš»æ¯å­ã€‚\næ¯å­å…§å´æœ‰ä¸€é“åˆ®ç—•ï¼Œåƒæ˜¯æœ‰äººç”¨æŒ‡ç”²æ€¥è‘—åˆ®æ‰æŸå€‹åå­—ã€‚\n\næˆ‘æƒ³èµ·ä½ èªªéï¼šã€å®¶æ˜¯æœ€å°çš„å®‡å®™ã€‚ã€\nä½†å®‡å®™å¦‚æœè¢«å‰ªæ‰ä¸€è§’ï¼Œé‚„ç®—å®‡å®™å—ï¼Ÿ" },
    { id:"note_002", title:"è–„è·çš„å‘³é“", content:"è–„è·æ‡‰è©²æ¸…æ¶¼ã€‚\nå¯ä»Šå¤©å®ƒå¸¶è‘—æ²¹æ¼†å‘³ã€‚\næˆ‘æŠŠé¼»å­æ¹Šè¿‘æ™‚ï¼Œå¿½ç„¶è¦ºå¾—é‚£ä¸æ˜¯æ¤ç‰©ï¼Œè€Œæ˜¯æŸç¨®ã€è¨˜æ†¶çš„æ›¿èº«ã€ã€‚\n\nä½ æœ‰æ²’æœ‰æƒ³éï¼š\næˆ‘å€‘è¨˜å¾—çš„ï¼Œæ˜¯åŒä¸€ä»¶äº‹å—ï¼Ÿ" },
    { id:"note_003", title:"å¤±è¹¤ç•¶æ™šï¼ˆç¢ç‰‡ï¼‰", content:"ç‡ˆæ²’æœ‰å£ã€‚\nå£çš„æ˜¯æˆ‘å°å…‰çš„ä¿¡ä»»ã€‚\n\nä»–èªªï¼šã€æˆ‘å»ä¸€ä¸‹å°±å›ä¾†ã€‚ã€\nå¯æ˜¯ã€ä¸€ä¸‹ã€æ˜¯å€‹å¾ˆç‹¡çŒ¾çš„å–®ä½ã€‚\nå®ƒå¯ä»¥è®Šæˆä¸€è¼©å­ã€‚" }
  ],

  gallery: [
    { id:"gallery_001", caption:"æ¯å­ / å®¢å»³ / ä½é›»é‡ 1%", src: makeInlineSVGDataURI("cup_001") },
    { id:"gallery_002", caption:"çª—ç°¾ç¸«éš™ / ç©ºæ°£åƒè¢«æ‘ºç–Š", src: makeInlineSVGDataURI("curtain_001") },
    { id:"gallery_003", caption:"é–€å£ç…§ç‰‡ / é–€ç‰Œè™Ÿç¢¼ä¸ä¸€è‡´", src: makeInlineSVGDataURI("door_001") }
  ],

  system: {
    flags: {
      lowPower: true,
      glitchSensitivity: 0.65,
      lockState: false
    },
    device: {
      model: "AETHEL-01",
      osVersion: "Entropyè£‚ç¸« / build 0.9.3",
      storage: "ARCHIVE: 13% free",
      network: "5G (unstable)"
    }
  }
};


/* =========================================================
   CHAPTER STRUCTURE & PHILOSOPHICAL LOOP
   - Materialism choices advance state
   - Idealism choices loop memory fragments
   ========================================================= */

const LOOP_THRESHOLD = 3; // how many times idealism can repeat before obvious stasis

function applyChoiceEffect(choice, state){
  if(choice.val.mind > choice.val.material){
    state.loopCount = (state.loopCount || 0) + 1;
    state.progress = Math.max(0, state.progress - 1);
  }else{
    state.loopCount = 0;
    state.progress += 1;
  }

  if(state.loopCount >= LOOP_THRESHOLD){
    state.flags = state.flags || {};
    state.flags.stuckInMemory = true;
  }
}

/**
 * Refined dialogue generator:
 * - Everyday first (mundane domestic detail)
 * - One rational explanation suggested by the player
 * - One irrational temptation that causes looping
 * - Horror only appears in the last line
 */
function generateChapter2Stages(count=18, startIndex=100){
  const base = [];
  const scenes = [
    {
      daily:"æˆ‘å‰›å‰›æŠŠç¢—ç›¤æ”¶é€²æ«ƒå­è£¡ã€‚ç¢—ç–Šå¾—å¾ˆå¥½ï¼Œæ²’æœ‰è²éŸ³ã€‚",
      rational:"ä¹Ÿè¨±åªæ˜¯æˆ‘è¨˜éŒ¯æ•¸é‡ã€‚",
      irrational:"å¯æ˜¯å¦‚æœå®ƒè‡ªå·±å¤šå‡ºä¾†å‘¢ï¼Ÿ",
      horror:"æˆ‘é—œä¸Šæ«ƒé–€æ™‚ï¼Œè£¡é¢å‚³ä¾†ç¬¬ä¸‰æ¬¡ç¢°æ’è²ã€‚"
    },
    {
      daily:"æˆ‘åœ¨æ‘ºè¡£æœã€‚ä½ çš„è¡£æœé‚„æ˜¯ç¿’æ…£æ‘ºåœ¨å·¦é‚Šã€‚",
      rational:"äººæœƒç•™ä¸‹ç¿’æ…£ï¼Œç‰©å“ä¸æœƒèªªè¬Šã€‚",
      irrational:"å¦‚æœç¿’æ…£æ¯”äººæ´»å¾—ä¹…å‘¢ï¼Ÿ",
      horror:"æˆ‘ç™¼ç¾é‚£ä»¶è¡£æœçš„å°ºå¯¸ä¸æ˜¯ä½ çš„ã€‚"
    },
    {
      daily:"æˆ‘æŠŠåƒåœ¾æ‹¿å»ä¸Ÿï¼Œèµ°å»Šçš„ç‡ˆä¸€ç›ä¸€ç›äº®èµ·ä¾†ã€‚",
      rational:"æ„Ÿæ‡‰ç‡ˆæœ¬ä¾†å°±æœƒå»¶é²ã€‚",
      irrational:"å¦‚æœå®ƒæ˜¯åœ¨ç­‰æˆ‘ç¶“éå‘¢ï¼Ÿ",
      horror:"æœ€å¾Œä¸€ç›ç‡ˆæ²’æœ‰äº®ã€‚"
    },
    {
      daily:"æˆ‘ç…§è‘—é£Ÿè­œç…®æ¹¯ï¼Œé¹½æ”¾å¾—å‰›å¥½ã€‚",
      rational:"å‘³é“ç©©å®šï¼Œä»£è¡¨äº‹æƒ…é‚„åœ¨æ§åˆ¶ä¸­ã€‚",
      irrational:"ä½†ä½ ä»¥å‰èªªæˆ‘é¹½æ”¾å¤ªå¤šã€‚",
      horror:"æ¹¯æ»¾èµ·ä¾†æ™‚ï¼Œæˆ‘è½è¦‹æœ‰äººèªªã€å¤ªé¹¹äº†ã€ã€‚"
    }
  ];

  for(let i=0;i<count;i++){
    const idx = startIndex + i;
    const s = scenes[i % scenes.length];

    base.push({
      id:`msg_${idx}`,
      sender:"Lover",
      text:`${s.daily}`,
      thriller:`${s.horror}`,
      style:"yoshimoto",
      replies:[
        {
          text:`ã€Œ${s.rational}ã€`,
          val:{ material: 8, mind: 0 },
          unlock:(i%5===0)?["note_material_progress"]:[]
        },
        {
          text:`ã€Œ${s.irrational}ã€`,
          val:{ material: 0, mind: 8 },
          unlock:["note_memory_loop"]
        }
      ]
    });
  }
  return base;
}

/* =========================================================
   CHAPTER END â€” MATERIAL TRUTH REVEAL
   ========================================================= */

const chapterEndEvent = {
  id:"system_end_001",
  sender:"SYSTEM",
  text:"ARCHIVE SYNC COMPLETE",
  thriller:"Status: SUBJECT_CONFIRMED_DECEASED\nLast physical record: 14:20\n\nMemory continuation detected.\nRational path required to proceed.",
  style:"system",
  replies:[
    { text:"ï¼ˆé—œé–‰ï¼‰", val:{ material: 0, mind: 0 } }
  ]
};

// Append Chapter 2 and ending
ScriptDB.chat.inbox = [
  ...ScriptDB.chat.inbox,
  ...generateChapter2Stages(18, 100),
  chapterEndEvent
];

// Notes clarifying philosophy
ScriptDB.notes.push(
  {
    id:"note_material_progress",
    title:"ç‰©çš„é€£çºŒæ€§",
    content:"ç‰©ä¸æœƒæ‡·å¿µä½ ã€‚\nå®ƒå€‘åªæœƒç•™åœ¨åŸåœ°ã€‚\n\næ‰€ä»¥å¦‚æœä½ æƒ³å‰é€²ï¼Œ\nä½ å¿…é ˆç›¸ä¿¡ã€ç•™ä¸‹ä¾†çš„æ˜¯ç‰©ï¼Œä¸æ˜¯äººã€ã€‚"
  },
  {
    id:"note_memory_loop",
    title:"è¨˜æ†¶å¾ªç’°",
    content:"åªè¦ä½ é¸æ“‡ç›¸ä¿¡æ„Ÿè¦ºï¼Œ\nä¸–ç•Œå°±æœƒç‚ºä½ ä¿ç•™é‚£ä¸€åˆ»ã€‚\n\nä½†è¢«ä¿ç•™ä¸‹ä¾†çš„ï¼Œ\nå¾ä¾†ä¸æ˜¯å°æ–¹ã€‚"
  }
);


// Extra writing to thicken the world (less hollow)
ScriptDB.notes.push(
  { id:"note_004", title:"æ¨™é»ç¬¦è™Ÿ", content:"é‚£å¼µä¾¿æ¢ç´™æœ€å¯æ€•çš„ä¸æ˜¯å¥å­ã€‚\næ˜¯é€—è™Ÿã€‚\nä½ çš„é€—è™Ÿç¿’æ…£æ€§å¾€å·¦é ä¸€é»ã€‚\nä½†é‚£å¼µç´™ä¸Šçš„é€—è™Ÿå¤ªå®Œç¾ï¼Œåƒæ˜¯æ¨¡ä»¿ã€‚\n\næ¨¡ä»¿é€šå¸¸ä¸æ˜¯ç‚ºäº†æ¬ºé¨™ã€‚\næ¨¡ä»¿æ˜¯ç‚ºäº†å–ä»£ã€‚" },

  { id:"note_005", title:"éŒ¯å¾—å¾ˆæ•´é½Š", content:"é–€ç‰ŒéŒ¯ä¸€ä½ï¼Œè¡¨ç¤ºã€éŒ¯ã€ä¸æ˜¯å¤±èª¤ã€‚\næ˜¯è¢«ç¶­è­·çš„ç‹€æ…‹ã€‚\n\nå¦‚æœéŒ¯æ˜¯è¢«ç¶­è­·çš„ï¼Œé‚£æ­£ç¢ºåœ¨å“ªè£¡ï¼Ÿ\næ­£ç¢ºæ˜¯ä¸æ˜¯åè€Œè®Šæˆä¸€ç¨®ç¦å¿Œï¼Ÿ" },

  { id:"note_006", title:"14:20", content:"æˆ‘æŠŠ 14:20 å¯«åœ¨ç´™ä¸Šã€‚\nå¯«å®Œçš„ä¸€ç¬é–“ï¼Œæˆ‘è½åˆ°åƒé›»æ¢¯é—œé–€çš„è²éŸ³ã€‚\nä½†å®¶è£¡æ²’æœ‰é›»æ¢¯ã€‚\n\næ™‚é–“åƒé–€ã€‚\né–€ä¸€æ—¦é—œä¸Šï¼Œå°±æœ‰äººè¢«ç•™åœ¨å¤–é¢ã€‚" },

  { id:"note_007", title:"åŒä¸€å€‹äºº", content:"åŒä¸€å€‹äººï¼Œæ˜¯æŒ‡åŒä¸€æ®µè¨˜æ†¶å—ï¼Ÿ\né‚„æ˜¯åŒä¸€å¥—åæ‡‰ï¼Ÿ\n\nå¦‚æœæœ‰äººæŠŠè¨˜æ†¶å‰ªæ‰ä¸€è§’ï¼Œä½ é‚„æœƒæ„›é‚£å€‹äººå—ï¼Ÿ\næˆ–è€…ä½ æ„›çš„æ˜¯ã€ä½ ä»¥ç‚ºä»–æœƒåšå‡ºçš„é¸æ“‡ã€ï¼Ÿ" }
);

ScriptDB.gallery.push(
  { id:"gallery_004", caption:"ä¾¿æ¢ç´™ç‰¹å¯« / å­—è·¡åƒä½ ä½†ä¸å®Œå…¨åƒ", src: makeInlineSVGDataURI("note_paper_close_001") }
);



/* =========================================================
   PART 3 â€” Consciousness Audit (micro-actions)
   ========================================================= */
class ConsciousnessAudit{
  constructor(){
    this.reset();
  }

  reset(){
    this.metrics = {
      // Scores (material vs mind)
      materialScore: 0,
      mindScore: 0,

      // micro-actions counters
      taps: 0,
      appSwitches: 0,
      repliesChosen: 0,
      notesOpened: 0,
      photosOpened: 0,
      settingsOpened: 0,
      scrollDistance: 0,

      // derived
      coherence: 50,     // 0..100
      drift: 0,          // mind - material (normalized)
      anxiety: 12        // 0..100 (fictional)
    };
    this.timeline = []; // [{t, material, mind, coherence}]
  }

  applyDelta(delta){
    // delta: {material, mind}
    const m = this.metrics;
    m.materialScore += (delta.material || 0);
    m.mindScore += (delta.mind || 0);

    // drift: mind-material
    const rawDrift = m.mindScore - m.materialScore;
    m.drift = clamp(rawDrift, -100, 100);

    // coherence logic (fictional but consistent):
    // too extreme drift reduces coherence; balanced increases
    const balance = 100 - Math.abs(m.drift);
    const act = m.repliesChosen + m.appSwitches + Math.floor(m.scrollDistance/800);
    m.coherence = clamp(Math.floor((balance*0.55) + (act*1.2)), 0, 100);

    // anxiety: rises with mind focus + low power & glitches (handled elsewhere)
    m.anxiety = clamp(Math.floor(10 + (m.mindScore*0.9) + (Math.abs(m.drift)*0.25)), 0, 100);

    this.timeline.push({
      t: Date.now(),
      material: m.materialScore,
      mind: m.mindScore,
      coherence: m.coherence
    });
  }

  bump(action){
    const m = this.metrics;
    if(action==="tap") m.taps++;
    if(action==="app") m.appSwitches++;
    if(action==="reply") m.repliesChosen++;
    if(action==="note") m.notesOpened++;
    if(action==="photo") m.photosOpened++;
    if(action==="settings") m.settingsOpened++;
  }

  addScroll(px){
    this.metrics.scrollDistance += Math.abs(px);
  }

  report(){
    const m = this.metrics;
    // A compact but â€œaudit-ishâ€ report (can be expanded infinitely)
    const bias = (m.drift>=0) ? "Mind-heavy" : "Material-heavy";
    const level =
      m.coherence>=75 ? "STABLE" :
      m.coherence>=50 ? "FLUCTUATING" :
      "FRACTURED";

    return [
      `=== Consciousness Audit Report ===`,
      `bias=${bias}`,
      `materialScore=${m.materialScore}`,
      `mindScore=${m.mindScore}`,
      `coherence=${m.coherence}/100`,
      `anxiety=${m.anxiety}/100`,
      `micro_actions: taps=${m.taps}, appSwitches=${m.appSwitches}, replies=${m.repliesChosen}, notes=${m.notesOpened}, photos=${m.photosOpened}, settings=${m.settingsOpened}`,
      `scrollDistance(px)=${Math.floor(m.scrollDistance)}`,
      `state=${level}`,
    ].join("\n");
  }
}

/* =========================================================
   Dialog Engine
   - Typewriter rendering
   - Inline image support
   - Reply options + score deltas + unlock
   ========================================================= */
class DialogEngine{
  constructor(rootBody, replyDock, audit, hooks){
    this.rootBody = rootBody;
    this.replyDock = replyDock;
    this.audit = audit;
    this.hooks = hooks;

    this.typing = false;
  }

  clear(){
    this.rootBody.innerHTML = "";
    this.replyDock.innerHTML = "";
  }

  ensureThread(){
    let thread = this.rootBody.querySelector(".chat-thread");
    if(!thread){
      thread = document.createElement("div");
      thread.className = "chat-thread";
      this.rootBody.appendChild(thread);
    }
    return thread;
  }

  mkMessageBubble({sender, text, mine=false, timeStr, img}){
    const el = document.createElement("div");
    el.className = "msg" + (mine ? " mine" : "");
    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span class="sender">${escapeHtml(sender)}</span><span class="time">${escapeHtml(timeStr||nowHHMM())}</span>`;
    const tx = document.createElement("div");
    tx.className = "text";
    tx.textContent = ""; // filled by typewriter or immediate

    el.appendChild(meta);
    el.appendChild(tx);

    if(img && img.src){
      const wrap = document.createElement("div");
      wrap.className = "inline-img";
      const im = document.createElement("img");
      im.src = img.src;
      im.alt = img.caption || "image";
      wrap.appendChild(im);
      el.appendChild(wrap);

      if(img.caption){
        const cap = document.createElement("div");
        cap.style.marginTop = "8px";
        cap.style.fontSize = "11px";
        cap.style.color = "rgba(233,238,242,.70)";
        cap.textContent = img.caption;
        el.appendChild(cap);
      }
    }

    return { el, tx };
  }

  async typewriter(targetEl, fullText, opts={}){
    const { minDelay=12, maxDelay=28 } = opts;
    this.typing = true;

    targetEl.textContent = "";
    const caret = document.createElement("span");
    caret.className = "typewriter-caret";
    caret.textContent = "â–ˆ";
    targetEl.appendChild(caret);

    for(let i=0;i<fullText.length;i++){
      caret.remove();
      targetEl.textContent += fullText[i];
      targetEl.appendChild(caret);

      const d = minDelay + Math.random()*(maxDelay-minDelay);
      await sleep(d);
      this.hooks.onTypeChar?.(fullText[i], i);
    }

    caret.remove();
    this.typing = false;
  }

  setReplies(replies, onChoose){
    this.replyDock.innerHTML = "";
    replies.forEach((r, idx)=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = r.text;
      b.addEventListener("click", ()=>{
        if(this.typing) return;
        onChoose(r, idx);
      });
      this.replyDock.appendChild(b);
    });
  }

  disableReplies(){
    $$(".btn", this.replyDock).forEach(b=>b.classList.add("disabled"));
  }

  scrollToBottom(){
    this.rootBody.scrollTop = this.rootBody.scrollHeight;
  }
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   App Renderers
   ========================================================= */
function renderNotesApp(root, notes, onOpen){
  root.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "notes-wrap";
  notes.forEach(n=>{
    const card = document.createElement("div");
    card.className = "note-card";
    const h = document.createElement("h4");
    h.textContent = n.title;
    const p = document.createElement("p");
    p.textContent = n.content;
    card.appendChild(h);
    card.appendChild(p);
    card.addEventListener("click", ()=>onOpen(n.id));
    wrap.appendChild(card);
  });
  root.appendChild(wrap);
}

function renderGalleryApp(root, photos, onOpen){
  root.innerHTML = "";
  const grid = document.createElement("div");
  grid.className = "gallery-grid";
  photos.forEach(ph=>{
    const item = document.createElement("div");
    item.className = "photo";
    item.innerHTML = `
      <img src="${ph.src}" alt="photo" />
      <div class="cap">${escapeHtml(ph.caption)}</div>
    `;
    item.addEventListener("click", ()=>onOpen(ph.id));
    grid.appendChild(item);
  });
  root.appendChild(grid);
}

function renderSystemApp(root, sys, audit){
  root.innerHTML = "";
  const wrap = document.createElement("div");
  wrap.className = "sys-wrap";

  const c1 = document.createElement("div");
  c1.className = "sys-card";
  c1.innerHTML = `
    <div class="row"><span>Model</span><span class="tag blue">${escapeHtml(sys.device.model)}</span></div>
    <div class="row"><span>OS</span><span class="tag">${escapeHtml(sys.device.osVersion)}</span></div>
    <div class="row"><span>Storage</span><span class="tag">${escapeHtml(sys.device.storage)}</span></div>
    <div class="row"><span>Network</span><span class="tag">${escapeHtml(sys.device.network)}</span></div>
  `;

  const c2 = document.createElement("div");
  c2.className = "sys-card";
  const flags = sys.flags;
  c2.innerHTML = `
    <div class="row"><span>Low Power</span><span class="tag ${flags.lowPower?'green':''}">${flags.lowPower ? "ON" : "OFF"}</span></div>
    <div class="row"><span>Glitch Sensitivity</span><span class="tag">${flags.glitchSensitivity.toFixed(2)}</span></div>
    <div class="row"><span>Lock State</span><span class="tag">${flags.lockState ? "LOCKED" : "UNLOCKED"}</span></div>
  `;

  const c3 = document.createElement("div");
  c3.className = "sys-card";
  c3.innerHTML = `<div style="white-space:pre-wrap;color:rgba(233,238,242,.88);font-size:12px;line-height:1.45;">${escapeHtml(audit.report())}</div>`;

  wrap.appendChild(c1);
  wrap.appendChild(c2);
  wrap.appendChild(c3);
  root.appendChild(wrap);
}

/* =========================================================
   Chart Renderer (monitor)
   - simple: material vs mind + coherence
   ========================================================= */
class MonitorChart{
  constructor(canvas){
    this.canvas = canvas;
    this.ctx = canvas.getContext("2d");
  }

  draw(audit){
    const ctx = this.ctx;
    const w = this.canvas.width;
    const h = this.canvas.height;
    ctx.clearRect(0,0,w,h);

    // background
    ctx.fillStyle = "rgba(0,0,0,0.15)";
    ctx.fillRect(0,0,w,h);

    const m = audit.metrics;

    // axes
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(24, 16);
    ctx.lineTo(24, h-22);
    ctx.lineTo(w-14, h-22);
    ctx.stroke();

    // bars
    const maxScore = Math.max(10, m.materialScore, m.mindScore);
    const barW = 52;
    const gap = 20;
    const baseY = h - 22;

    // material
    const matH = Math.floor((m.materialScore / maxScore) * (h-56));
    ctx.fillStyle = "rgba(0,242,255,0.22)";
    ctx.fillRect(54, baseY-matH, barW, matH);

    // mind
    const mindH = Math.floor((m.mindScore / maxScore) * (h-56));
    ctx.fillStyle = "rgba(255,62,62,0.20)";
    ctx.fillRect(54+barW+gap, baseY-mindH, barW, mindH);

    // coherence line
    const cohY = baseY - Math.floor((m.coherence/100) * (h-56));
    ctx.strokeStyle = "rgba(0,255,65,0.45)";
    ctx.beginPath();
    ctx.moveTo(24, cohY);
    ctx.lineTo(w-14, cohY);
    ctx.stroke();

    // labels
    ctx.fillStyle = "rgba(233,238,242,0.78)";
    ctx.font = "12px Courier New";
    ctx.fillText("material", 52, 20);
    ctx.fillText("mind", 52+barW+gap, 20);

    ctx.fillStyle = "rgba(0,255,65,0.78)";
    ctx.fillText(`coherence=${m.coherence}`, 24, cohY-6);

    // stats
    ctx.fillStyle = "rgba(233,238,242,0.68)";
    ctx.font = "11px Courier New";
    ctx.fillText(`drift=${m.drift}`, 24, h-8);
  }
}

/* =========================================================
   AethelOS â€” State Machine
   ========================================================= */
class AethelOS{
  constructor(){
    // DOM
    this.body = $("#content-body");
    this.replyDock = $("#reply-options");
    this.tagApp = $("#tag-app");
    this.tagState = $("#tag-state");

    // engines
    this.vfx = new VFXEngine($("#vfx-canvas"), $("#glitch"));
    this.audit = new ConsciousnessAudit();
    this.dialog = new DialogEngine(this.body, this.replyDock, this.audit, {
      onTypeChar: ()=> {
        // micro-glitch chance while typing (low power intensifies)
        if(ScriptDB.system.flags.lowPower && Math.random()<0.012){
          this.triggerGlitch("typing");
        }
      }
    });
    this.chart = new MonitorChart($("#chart-canvas"));

    // state
    this.state = {
      currentApp: "chat",
      progressIdx: 0,      // points to ScriptDB.chat.inbox index
      isLocked: false
    };

    // unlock registry
    this.unlocked = new Set(["note_001","note_002","gallery_001","gallery_002","gallery_003"]); // can start generous or strict
    // if you want gating from start, set only minimal:
    // this.unlocked = new Set([]);

    // init
    this.bindEvents();
    this.vfx.tick(performance.now());
    this.runClock();
    this.routeTo("chat", {silent:true});
    this.logBoot();
    this.renderMonitor();
  }

  logBoot(){
    softLog([
      `[BOOT] AETHEL OS started`,
      `[BOOT] build=${ScriptDB.system.device.osVersion}`,
      `[BOOT] lowPower=${ScriptDB.system.flags.lowPower}`,
      `---`
    ]);
  }

  runClock(){
    const clock = $("#clock");
    const battery = $("#battery");
    const signal = $("#signal");
    const tick = ()=>{
      clock.textContent = nowHHMM();
      // fake battery drift
      const b = ScriptDB.system.flags.lowPower ? "1%" : "42%";
      battery.textContent = b;
      if(ScriptDB.system.flags.lowPower){
        // degrade signal slightly
        signal.textContent = (Math.random()<0.35) ? "[|||  ]" : "[|||| ]";
      }
      setTimeout(tick, 800);
    };
    tick();
  }

  bindEvents(){
    // nav switch
    $$(".app-icon").forEach(icon=>{
      icon.addEventListener("click", ()=>{
        const app = icon.dataset.app;
        this.audit.bump("tap");
        this.routeTo(app);
      });
    });

    // scroll tracking
    let lastScrollTop = 0;
    this.body.addEventListener("scroll", ()=>{
      const d = this.body.scrollTop - lastScrollTop;
      lastScrollTop = this.body.scrollTop;
      this.audit.addScroll(d);
      // mild coherence effect through activity
      if(Math.random()<0.05){
        this.audit.applyDelta({material:0, mind:0});
        this.renderMonitor();
      }
    });
  }

  routeTo(app, opts={}){
    if(this.state.isLocked && app!=="system"){
      this.toastLocked();
      return;
    }

    if(app !== this.state.currentApp){
      this.audit.bump("app");
      this.audit.metrics.appSwitches++;
    }

    this.state.currentApp = app;
    this.tagApp.textContent = `APP: ${app}`;
    this.tagState.textContent = `STATE: ${this.state.isLocked ? "LOCKED" : "ACTIVE"}`;
    this.tagState.className = "tag green";

    // UI active highlight
    $$(".app-icon").forEach(i=>i.classList.toggle("active", i.dataset.app===app));

    if(app==="chat") this.renderChat(opts);
    if(app==="notes") this.renderNotes(opts);
    if(app==="gallery") this.renderGallery(opts);
    if(app==="system") this.renderSystem(opts);

    this.renderMonitor();
  }

  renderChat(opts={}){
    if(!opts.silent) softLog(`[NAV] chat`);

    this.dialog.clear();
    const thread = this.dialog.ensureThread();

    // render existing history
    ScriptDB.chat.history.forEach(h=>{
      const bubble = this.dialog.mkMessageBubble({
        sender: h.sender,
        text: h.renderedText || h.text,
        mine: h.mine,
        timeStr: h.timeStr,
        img: h.img
      });
      bubble.tx.textContent = h.renderedText || h.text;
      thread.appendChild(bubble.el);
    });

    // load next message
    this.loadNextMessage();
  }

  async loadNextMessage(){
    const idx = this.state.progressIdx;
    const msg = ScriptDB.chat.inbox[idx];

    if(!msg){
      // end sequence
      this.dialog.disableReplies();
      this.triggerFinalSequence();
      return;
    }

    // append lover message with typewriter
    const thread = this.dialog.ensureThread();

    const combined = msg.text + (msg.thriller ? ("\n\n" + msg.thriller) : "");
    const bubble = this.dialog.mkMessageBubble({
      sender: msg.sender,
      mine:false,
      img: msg.img
    });
    thread.appendChild(bubble.el);
    this.dialog.scrollToBottom();

    // Low power: occasional shake during thriller lines
    const isLow = ScriptDB.system.flags.lowPower;

    await this.dialog.typewriter(bubble.tx, combined, {minDelay: 10, maxDelay: isLow?26:20});
    this.dialog.scrollToBottom();

    // set replies
    this.dialog.setReplies(msg.replies || [], (choice)=>{
      this.handleChoice(choice);
    });
  }

  async handleChoice(choice){
    this.audit.bump("reply");
    this.audit.metrics.repliesChosen++;

    // disable old options
    this.dialog.disableReplies();

    // append "mine" bubble
    const thread = this.dialog.ensureThread();
    const bubble = this.dialog.mkMessageBubble({
      sender:"Me",
      mine:true
    });
    thread.appendChild(bubble.el);
    this.dialog.scrollToBottom();

    await this.dialog.typewriter(bubble.tx, choice.text, {minDelay: 6, maxDelay: 16});
    this.dialog.scrollToBottom();

    // apply score
    this.audit.applyDelta(choice.val || {material:0, mind:0});

    // unlock
    (choice.unlock || []).forEach(u=>this.unlock(u));

    // progress forward
    this.state.progressIdx += 1;

    // low power: respond glitch more often
    if(ScriptDB.system.flags.lowPower && Math.random()<0.22){
      this.triggerGlitch("lowpower_reply");
      this.vibrate();
    }

    // write to history
    ScriptDB.chat.history.push({
      sender:"Lover",
      text:"", // already rendered in DOM, but keep placeholder for future persistence
      mine:false,
      timeStr: nowHHMM()
    });
    ScriptDB.chat.history.push({
      sender:"Me",
      text: choice.text,
      renderedText: choice.text,
      mine:true,
      timeStr: nowHHMM()
    });

    this.renderMonitor();
    await sleep(240);
    await this.loadNextMessage();
  }

  unlock(key){
    if(!key) return;

    if(key.startsWith("note_")){
      this.unlocked.add(key);
      this.markAppNew("notes");
      softLog(`[UNLOCK] notes: ${key}`);
      return;
    }
    if(key.startsWith("gallery_")){
      this.unlocked.add(key);
      this.markAppNew("gallery");
      softLog(`[UNLOCK] gallery: ${key}`);
      return;
    }
    if(key.startsWith("sys_flag_")){
      // example: sys_flag_lowpower
      if(key==="sys_flag_lowpower"){
        ScriptDB.system.flags.lowPower = true;
        softLog(`[FLAG] lowPower forced ON`);
        this.triggerGlitch("flag_lowpower");
        return;
      }
    }
    // unknown keys may be used later
    softLog(`[UNLOCK] ${key}`);
  }

  markAppNew(app){
    const el = $(`.app-icon[data-app="${app}"]`);
    if(el) el.classList.add("has-new");
  }

  clearAppNew(app){
    const el = $(`.app-icon[data-app="${app}"]`);
    if(el) el.classList.remove("has-new");
  }

  renderNotes(opts={}){
    if(!opts.silent) softLog(`[NAV] notes`);
    this.clearAppNew("notes");

    // filter unlocked notes (if you want gating)
    const notes = ScriptDB.notes.filter(n => this.unlocked.has(n.id) || this.unlocked.size===0);

    renderNotesApp(this.body, notes, (noteId)=>{
      this.audit.bump("note");
      this.audit.metrics.notesOpened++;
      this.audit.applyDelta({material:0, mind:2});
      this.vibrate();
      softLog(`[OPEN] note=${noteId}`);
      this.renderMonitor();
    });

    this.replyDock.innerHTML = `<button class="btn" id="btn-back-chat">å›åˆ°å°è©±</button>`;
    $("#btn-back-chat").addEventListener("click", ()=>{
      this.audit.bump("tap");
      this.routeTo("chat");
    });
  }

  renderGallery(opts={}){
    if(!opts.silent) softLog(`[NAV] gallery`);
    this.clearAppNew("gallery");

    const photos = ScriptDB.gallery.filter(p => this.unlocked.has(p.id) || this.unlocked.size===0);

    renderGalleryApp(this.body, photos, (photoId)=>{
      this.audit.bump("photo");
      this.audit.metrics.photosOpened++;
      this.audit.applyDelta({material:2, mind:1});
      this.triggerGlitch("photo_open");
      softLog(`[OPEN] photo=${photoId}`);
      this.renderMonitor();
    });

    this.replyDock.innerHTML = `<button class="btn" id="btn-back-chat2">å›åˆ°å°è©±</button>`;
    $("#btn-back-chat2").addEventListener("click", ()=>{
      this.audit.bump("tap");
      this.routeTo("chat");
    });
  }

  renderSystem(opts={}){
    if(!opts.silent) softLog(`[NAV] system`);
    this.audit.bump("settings");
    this.audit.metrics.settingsOpened++;

    renderSystemApp(this.body, ScriptDB.system, this.audit);

    this.replyDock.innerHTML = `
      <button class="btn" id="btn-toggle-power">åˆ‡æ› Low Power</button>
      <button class="btn" id="btn-glitch-now">å¼·åˆ¶ Glitch</button>
      <button class="btn" id="btn-back-chat3">å›åˆ°å°è©±</button>
    `;

    $("#btn-toggle-power").addEventListener("click", ()=>{
      this.audit.bump("tap");
      ScriptDB.system.flags.lowPower = !ScriptDB.system.flags.lowPower;
      softLog(`[SYS] lowPower=${ScriptDB.system.flags.lowPower}`);
      this.vibrate();
      this.triggerGlitch("toggle_power");
      this.routeTo("system", {silent:true});
    });

    $("#btn-glitch-now").addEventListener("click", ()=>{
      this.audit.bump("tap");
      this.triggerGlitch("manual");
      this.vibrate();
    });

    $("#btn-back-chat3").addEventListener("click", ()=>{
      this.audit.bump("tap");
      this.routeTo("chat");
    });
  }

  renderMonitor(){
    // monitor chart + log summary
    this.chart.draw(this.audit);

    // Also refresh system preview tags
    this.tagApp.textContent = `APP: ${this.state.currentApp}`;
    this.tagState.textContent = `STATE: ${this.state.isLocked ? "LOCKED" : "ACTIVE"}`;

    // Occasionally dump audit snapshot
    if(Math.random()<0.08){
      softLog(`[AUDIT] coherence=${this.audit.metrics.coherence} drift=${this.audit.metrics.drift} anxiety=${this.audit.metrics.anxiety}`);
    }
  }

  toastLocked(){
    softLog(`[LOCK] device locked; only system app available`);
    this.vibrate();
    this.triggerGlitch("locked");
  }

  vibrate(){
    // simulate vibration (shake phone-display)
    const phone = $("#phone-display");
    phone.classList.remove("shake");
    void phone.offsetWidth;
    phone.classList.add("shake");
  }

  triggerGlitch(reason){
    // reason: string
    const g = $("#glitch");
    g.classList.remove("glitch-on");
    void g.offsetWidth;
    g.classList.add("glitch-on");
    softLog(`[GLITCH] reason=${reason}`);
  }

  async triggerFinalSequence(){
    // A minimal but expandable ending.
    // You can extend into 200+ lines of staged animation.
    softLog(`---`);
    softLog(`[FINAL] entering forced material ending sequence`);

    // Lock non-system apps
    this.state.isLocked = true;
    ScriptDB.system.flags.lockState = true;

    // Clear replies and show a â€œsystem noticeâ€
    this.replyDock.innerHTML = "";
    const thread = this.dialog.ensureThread();

    const b1 = this.dialog.mkMessageBubble({
      sender:"SYSTEM",
      mine:false
    });
    thread.appendChild(b1.el);
    await this.dialog.typewriter(b1.tx,
      "ä½é›»é‡æ¨¡å¼å·²æŒçºŒ 6 å°æ™‚ã€‚\n\nç³»çµ±åµæ¸¬åˆ°ï¼šã€å¯é©—è­‰ç¾å¯¦ã€èˆ‡ã€è¨˜æ†¶ç‰ˆæœ¬ã€å‡ºç¾è¡çªã€‚\n\nç‚ºç¶­æŒè£ç½®å¯ç”¨æ€§ï¼Œå°‡å„ªå…ˆè¼‰å…¥ï¼šç‰©ç†å±¤ï¼ˆmaterialï¼‰çš„ç©©å®šè§£ã€‚",
      {minDelay: 10, maxDelay: 22}
    );
    this.dialog.scrollToBottom();

    await sleep(280);
    this.triggerGlitch("final_gate");
    this.vibrate();

    const b2 = this.dialog.mkMessageBubble({
      sender:"SYSTEM",
      mine:false
    });
    thread.appendChild(b2.el);
    await this.dialog.typewriter(b2.tx,
      "ä½ å°‡æœƒçœ‹åˆ°ï¼š\n1) å°‘é‡å¯è¢«è­‰æ˜çš„æ±è¥¿\n2) å¤§é‡ä¸èƒ½è¢«è­‰æ˜çš„ç¼ºå£\n\nè€Œç¼ºå£å°‡è¢«å‘½åç‚ºã€ä½ ã€ã€‚",
      {minDelay: 10, maxDelay: 24}
    );
    this.dialog.scrollToBottom();

    // route to system automatically after ending
    await sleep(450);
    this.routeTo("system");
  }
}

/* =========================================================
   Boot
   ========================================================= */
const game = new AethelOS();
</script>
</body>
</html>
